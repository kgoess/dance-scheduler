BACDS dance schedule manager
----

The sources for all this can be found in github https://github.com/kgoess/dance-scheduler

See that for documentation and schemas and more goodies.

Development
----

This app relies heavily on the Dancer2 project for the webapp infrastructure
and DBIx::Class for automating the relationship between the code and the
database schema.

    https://metacpan.org/dist/Dancer2/view/script/dancer2

    https://metacpan.org/pod/DBIx::Class

Any perl libs not available to centos-7 are in /var/lib/dance-scheduler,
so you'll want to run this before doing any dev

    eval $(perl -Mlocal::lib=/var/lib/dance-scheduler)

After running that 'eval', new modules get installed there via cpanm, e.g.
"cpanm DBIx::Class"

The files in lib/bacds/Scheduler/Schema\* were generated via

    dbicdump -o dump_directory=./lib \
         -o components='["InflateColumn::DateTime"]' \
         -o debug=1 \
         -o skip_load_external=1 \
         bacds::Scheduler::Schema \
         'dbi:mysql:dbname=schedule' \
         scheduler \
         $(cat ~/.mysql-password)

To start up dancer2 serving the content in the git repo on port :5000, e.g.
http://www.bacds.org:5000/signin.html run this:

    plackup bin/app.psgi


How To Make Schema Changes
----

1) Make your table changes
2) In this git repo, run that "eval" and "dbicdump" command in the
   "Development" section above, that will update the perl code.
3) Update the relevant files in the "schemas/" directory.
4) Run "make test" (see the "Install" section below for details) to see any
   changes needed in the unit tests and fix them up until they pass.
5) Then see the "Install" section below.


Install
----

    perl Makefile.PL
    make
    make test
    # or make test HARNESS_OPTIONS=j3 (there are only 2 cores on the fried VPS,
    # so "3" is the best speedup you'll get)

    # install the libraries to /var/lib/dance-scheduler
    make install

    # install the rest of the dancer2 app to /var/www/bacds.org/dance-scheduler
    make app-install

    # optional, the only one that requires sudo
    # install the dance-scheduler.conf to /etc/httpd/conf.d/
    sudo make httpd-conf-install

    sudo service httpd restart

(Those last two, "make app-install" and "make httpd-conf-install/" will be
replaced by rpm .spec files eventually. Keeping it this way for now so that we
can iterate more easily during development.)

Code Layout
----------

```
# these drive the dancer2 app
./environments
./environments/development.yml
./environments/production.yml
./config.yml
./bin/app.psgi

# these are TemplateToolkit templates that produce the html, dancer2 called the
# directory "view" as part of the MVC pattern
./views
./views/accordion2.tt
./views/bands.tt
./views/callers.tt
./views/index.tt
#...etc.

# lib contains the perl modules, they get installed to
# /var/lib/dance-scheduler/lib/perl5
./lib

# this is the main module and has all the url routes defined. It's the
# "Controller" in MVC
./lib/bacds/Scheduler.pm

# under Schema/Result are the DBIx::Class files, auto-generated by dbicdump
# with the additions we added in the marked "safe to update" sections
./lib/bacds/Scheduler/Schema.pm
./lib/bacds/Scheduler/Schema/Result
./lib/bacds/Scheduler/Schema/Result/EventStylesMap.pm
./lib/bacds/Scheduler/Schema/Result/Style.pm
./lib/bacds/Scheduler/Schema/Result/Talent.pm
#...etc.

# these "Model" classes drive that part of the MVC in the app, and handle
# requests and responses to the javascript app.
./lib/bacds/Scheduler/Model.pm
./lib/bacds/Scheduler/Model/Band.pm
./lib/bacds/Scheduler/Model/Caller.pm
./lib/bacds/Scheduler/Model/Style.pm
./lib/bacds/Scheduler/Model/Talent.pm
# ..etc

# FederatedAuth handles the different auth schemes--Google, Facebook, BACDS,
# etc.
./lib/bacds/Scheduler/FederatedAuth.pm

# various notes in doc and README.md
./README.md
./doc
./doc/HOW-TO-DBIx.md
./doc/dance-scheduler-erd.png
./doc/system-setup.txt
./doc/TODO.txt


./schemas
./schemas/drop-everything.sh
./schemas/create-everything.sh
./schemas/migrate-everything.sh
./schemas/programmer_series_map.sql
./schemas/programmers.sql
./schemas/styles.sql
./schemas/talent.sql
# ...etc.

# the mod_perl config
./apache/dance-scheduler.conf

# some utility scripts that get installed to /var/lib/dance-scheduler/bin/
# and the migration helpers (that don't get installed)
./bin
./bin/dance-scheduler-user-password.pl
./bin/dance-scheduler-add-programmer.pl
./bin/migrate-bands.pl
./bin/migrate-talent.pl
./bin/migrate-venues.pl
# ...etc

# css, javascript and static un-templated HTML
./public
./public/css
./public/images
./public/javascripts
./public/signin.html
./public/bacds-signin.html

# "t" contains the unit tests, see "make test" notes in this file
./t

```
